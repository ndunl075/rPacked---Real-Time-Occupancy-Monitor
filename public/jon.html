<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>rPacked - Live JON Capacity | Ohio State</title>
    
    <!-- === NEW FAVICON === -->
    <!-- This is an inline SVG favicon. It creates the scarlet "O" for your browser tab. -->
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon-180.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    <meta name="apple-mobile-web-app-title" content="rPacked">
    
    
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #F5F5F5;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* Prevent text size adjustment on iOS */
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
            /* Improve touch scrolling */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Ohio State colors */
        :root {
            --osu-scarlet: #BB0000;
            --osu-gray: #666666;
            --osu-light-gray: #E5E5E5;
        }
        
        /* Container and layout */
        .container {
            width: 100%;
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        /* Mobile-first: Reduce padding on small screens */
        @media (max-width: 640px) {
            .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
        }
        
        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }
        
        .max-w-5xl {
            max-width: 64rem;
        }
        
        /* Flexbox utilities */
        .flex {
            display: flex;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .items-center {
            align-items: center;
        }
        
        /* Grid utilities */
        .grid {
            display: grid;
        }
        
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        
        .gap-4 {
            gap: 1rem;
        }
        
        /* Mobile: Reduce gap for better space utilization */
        @media (max-width: 640px) {
            .gap-4 {
                gap: 0.75rem;
            }
        }
        
        /* Responsive grid */
        @media (min-width: 768px) {
            .md-grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        
        @media (min-width: 1024px) {
            .lg-grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        
        /* Responsive text - Tailwind sm: and md: breakpoints */
        @media (min-width: 640px) {
            .sm-text-3xl {
                font-size: 1.875rem;
                line-height: 2.25rem;
            }
            
            .sm-text-sm {
                font-size: 0.875rem;
                line-height: 1.25rem;
            }
        }
        
        /* Spacing utilities */
        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        .py-5 {
            padding-top: 1.25rem;
            padding-bottom: 1.25rem;
        }
        
        .py-6 {
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
        }
        
        .p-4 {
            padding: 1rem;
        }
        
        .p-5 {
            padding: 1.25rem;
        }
        
        .p-10 {
            padding: 2.5rem;
        }
        
        .px-3 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
        
        .py-1 {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        .mt-4 {
            margin-top: 1rem;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        
        .mb-3 {
            margin-bottom: 0.75rem;
        }
        
        /* Typography */
        .text-2xl {
            font-size: 1.5rem;
            line-height: 2rem;
        }
        
        .text-3xl {
            font-size: 1.875rem;
            line-height: 2.25rem;
        }
        
        .text-xs {
            font-size: 0.75rem;
            line-height: 1rem;
        }
        
        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        
        .text-lg {
            font-size: 1.125rem;
            line-height: 1.75rem;
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        /* Text colors */
        .text-white {
            color: #ffffff;
        }
        
        .text-gray-500 {
            color: #6b7280;
        }
        
        .text-gray-600 {
            color: #4b5563;
        }
        
        .text-gray-800 {
            color: #1f2937;
        }
        
        .text-gray-900 {
            color: #111827;
        }
        
        .text-gray-400 {
            color: #9ca3af;
        }
        
        /* Text alignment */
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .block {
            display: block;
        }
        
        /* Background colors */
        .bg-white {
            background-color: #ffffff;
        }
        
        /* Opacity */
        .opacity-80 {
            opacity: 0.8;
        }
        
        .opacity-90 {
            opacity: 0.9;
        }
        
        /* Shadows */
        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Border radius */
        .rounded-lg {
            border-radius: 0.5rem;
        }
        
        .rounded-full {
            border-radius: 9999px;
        }
        
        /* Display */
        .inline-block {
            display: inline-block;
        }
        
        /* Sizing */
        .w-full {
            width: 100%;
        }
        
        .h-4 {
            height: 1rem;
        }
        
        /* Overflow */
        .overflow-hidden {
            overflow: hidden;
        }
        
        /* Text truncation */
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Transitions */
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .transition-transform {
            transition-property: transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .duration-200 {
            transition-duration: 200ms;
        }
        
        .duration-300 {
            transition-duration: 300ms;
        }
        
        .duration-500 {
            transition-duration: 500ms;
        }
        
        /* Hover effects */
        .hover-scale-105:hover {
            transform: scale(1.05);
        }
        
        /* Custom styles for the progress bar background */
        .progress-bar-bg {
            background-color: var(--osu-light-gray);
        }
        
        .osu-scarlet {
            background-color: var(--osu-scarlet);
        }
        
        .osu-scarlet-text {
            color: var(--osu-scarlet);
        }
        
        .osu-gray-text {
            color: var(--osu-gray);
        }
        
        /* Animation styles */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        .card-animate {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
        
        .loading-spinner {
            border: 3px solid #E5E5E5;
            border-top: 3px solid #BB0000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        .shimmer {
            background: linear-gradient(
                90deg,
                #F5F5F5 0%,
                #E5E5E5 50%,
                #F5F5F5 100%
            );
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        .card-hover {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .number-counter {
            transition: all 0.3s ease;
        }
        
        #message-container {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        #message-container.fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        #capacity-grid {
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        #capacity-grid.fade-in {
            opacity: 1;
        }
        
        /* Facility Selector Styles */
        .facility-select {
            padding: 0.75rem 2.75rem 0.75rem 1.125rem;
            border-radius: 0.625rem;
            border: 1.5px solid rgba(255, 255, 255, 0.5);
            background-color: #ffffff;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 14 14'%3E%3Cpath fill='%234b5563' d='M7 10L2 5h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.875rem center;
            background-size: 14px;
            color: #1f2937;
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.01em;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            max-width: 400px;
            appearance: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
        }
        
        .facility-select:hover {
            background-color: #ffffff;
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }
        
        .facility-select:active {
            background-color: #ffffff;
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06);
        }
        
        .facility-select:focus {
            outline: none;
            border-color: #ffffff;
            background-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3), 0 4px 12px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        
        /* Mobile Optimizations */
        @media (max-width: 640px) {
            /* Ensure touch targets are at least 44x44px */
            .facility-select {
                min-height: 44px;
                font-size: 1rem; /* Prevent iOS zoom on focus */
                padding: 0.875rem 2.875rem 0.875rem 1.125rem;
            }
            
            /* Stack header on mobile */
            header .flex {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            
            header .text-right {
                text-align: left;
                width: 100%;
            }
            
            /* Better card padding on mobile */
            .p-5 {
                padding: 1rem;
            }
            
            /* Optimize text sizes for mobile readability */
            .text-3xl {
                font-size: 2rem;
                line-height: 2.5rem;
            }
            
            .text-lg {
                font-size: 1.25rem;
                line-height: 1.75rem;
            }
            
            /* Better spacing for status tags */
            .px-3 {
                padding-left: 0.875rem;
                padding-right: 0.875rem;
            }
            
            .py-1 {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            
            /* Improve main content padding */
            main.p-4 {
                padding: 0.75rem;
            }
            
            /* Better footer spacing */
            footer.py-6 {
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
        }
        
        /* Tablet optimizations */
        @media (min-width: 641px) and (max-width: 1023px) {
            .facility-select {
                min-height: 44px;
            }
        }
        
        /* Touch-friendly interactions */
        @media (hover: none) and (pointer: coarse) {
            /* Remove hover effects on touch devices */
            .card-hover:hover {
                transform: none;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            
            /* Add active state for touch feedback */
            .card-hover:active {
                transform: scale(0.98);
                box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            }
        }
        
        /* Prevent text selection on UI elements for better mobile UX */
        header, .facility-select, [data-status-tag] {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Allow text selection in cards for accessibility */
        .bg-white {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="shadow-md" style="background-color: #BB0000;">
        <div class="container mx-auto max-w-5xl px-4 py-5">
            <div class="flex justify-between items-center">
                <div>
                    <!-- === MOBILE-FRIENDLY HEADER TEXT === -->
                    <h1 class="text-2xl sm-text-3xl font-bold text-white">rPacked</h1>
                    <p class="text-sm text-white opacity-90">Ohio State University JON</p>
                </div>
                <div class="text-right">
                    <p class="text-xs sm-text-sm text-white">Live Jesse Owens North Capacity</p>
                    <p id="last-updated" class="text-xs text-white opacity-80">Updating...</p>
                </div>
            </div>
            <!-- Facility Selector Dropdown -->
            <div class="mt-4">
                <label for="facility-select" class="text-sm text-white opacity-90 block mb-2">Select Facility:</label>
                <select id="facility-select" class="facility-select" onchange="window.location.href=this.value">
                    <option value="index.html">RPAC - Recreation and Physical Activity Center</option>
                    <option value="nrc.html">NRC - North Recreation Center</option>
                    <option value="jon.html" selected>JON - Jesse Owens North</option>
                    <option value="jos.html">JOS - Jesse Owens South</option>
                </select>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto max-w-5xl p-4" id="app-container">
        
        <!-- Loading State -->
        <div id="message-container" class="text-center p-10">
            <div class="loading-spinner"></div>
            <p id="message-text" class="text-lg text-gray-500 mt-4">Connecting to live data...</p>
        </div>

        <!-- 
          === MOBILE-FRIENDLY GRID ===
          This class setup is perfect for mobile.
          'grid-cols-1' = 1 column by default (on phones)
          'md:grid-cols-2' = 2 columns on medium screens (tablets)
          'lg:grid-cols-3' = 3 columns on large screens (desktops)
        -->
        <div id="capacity-grid" class="grid grid-cols-1 md-grid-cols-2 lg-grid-cols-3 gap-4">
            <!-- Location cards will be injected here by JavaScript -->
        </div>

    </main>

    <!-- Footer -->
    <footer class="container mx-auto max-w-5xl px-4 py-6 text-center">
        <p class="text-sm text-gray-600">Created by Nico Dunlap</p>
    </footer>

    <!-- HTML Template for a single location card -->
    <template id="location-card-template">
        <div class="bg-white rounded-lg shadow-md overflow-hidden transition-all duration-300 card-hover">
            <div class="p-5">
                <h2 class="text-lg font-semibold text-gray-800 truncate" data-name>Location Name</h2>
                
                <!-- Status Tag -->
                <div class="mt-2 mb-3">
                    <span data-status-tag class="px-3 py-1 rounded-full text-sm font-medium inline-block transition-transform duration-200 hover-scale-105"></span>
                </div>

                <!-- Availability Text -->
                <div class="mb-2">
                    <span class="text-3xl font-bold text-gray-900" data-available-count>--</span>
                    <span class="text-lg font-medium text-gray-600" data-available-label>/ -- AVAILABLE</span>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full progress-bar-bg rounded-full h-4 overflow-hidden">
                    <div data-progress-bar class="h-4 rounded-full transition-all duration-500"></div>
                </div>

                <!-- Raw Count (sub-text) -->
                <p class="text-right text-sm text-gray-500 mt-2" data-raw-count>-- / --</p>
            </div>
        </div>
    </template>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        /*
         * === !!! NEW FIREBASE CONFIG !!! ===
         * This is the new, valid config you just generated by
         * re-creating the app in the Firebase console.
         * This should finally fix the 'api-key-not-valid' error.
         */
        const firebaseConfig = {
          apiKey: "AIzaSyA2kA0Al3xt8k2VJhPPw9HNWmOHbyhxRP0",
          authDomain: "rpacked-fd51e.firebaseapp.com",
          projectId: "rpacked-fd51e",
          storageBucket: "rpacked-fd51e.firebasestorage.app",
          messagingSenderId: "45513384003",
          appId: "1:45513384003:web:bcc58dbac9cb81d81b74f6",
          measurementId: "G-85G77S14XG"
        };
        // ----------------------------------------

        // Get DOM elements
        const grid = document.getElementById('capacity-grid');
        const template = document.getElementById('location-card-template');
        const messageContainer = document.getElementById('message-container');
        const messageText = document.getElementById('message-text');
        const lastUpdatedEl = document.getElementById('last-updated');

        /**
         * Animate a number from 0 to target value
         */
        function animateNumber(element, target, duration = 500) {
            const start = parseInt(element.textContent) || 0;
            const increment = target > start ? 1 : -1;
            const steps = Math.abs(target - start);
            const stepDuration = duration / steps;
            
            if (steps === 0) return;
            
            let current = start;
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= target) || (increment < 0 && current <= target)) {
                    element.textContent = target;
                    clearInterval(timer);
                } else {
                    element.textContent = current;
                }
            }, stepDuration);
        }

        /**
         * Add fade-in animation with stagger effect
         */
        function animateCardEntry(card, index) {
            card.classList.add('card-animate');
            card.style.animationDelay = `${index * 0.1}s`;
            
            // Remove animation class after animation completes to allow re-animation
            setTimeout(() => {
                card.classList.remove('card-animate');
            }, 500 + (index * 100));
        }

        /**
         * Pulse animation for live updates
         */
        function pulseElement(element) {
            element.style.animation = 'pulse 0.5s ease-in-out';
            setTimeout(() => {
                element.style.animation = '';
            }, 500);
        }

        /**
         * Renders a single location card with the new design.
         */
        function renderCapacityCard(location) {
            const card = template.content.cloneNode(true).firstElementChild;

            // --- Get all the data elements from the template ---
            const nameEl = card.querySelector('[data-name]');
            const statusTag = card.querySelector('[data-status-tag]');
            const availableCountEl = card.querySelector('[data-available-count]');
            const availableLabelEl = card.querySelector('[data-available-label]');
            const progressBar = card.querySelector('[data-progress-bar]');
            const rawCountEl = card.querySelector('[data-raw-count]');
            
            // --- Set basic info ---
            nameEl.textContent = location.name;
            rawCountEl.textContent = `${location.current} / ${location.total}`;

            // --- Calculate availability ---
            const current = location.current || 0;
            const total = location.total || 0;
            const available = Math.max(0, total - current);
            let percentUsed = 0;
            if (total > 0) {
                percentUsed = (current / total) * 100;
            }

            // --- 1. Set Status Tag (Open/Closed) ---
            const isOpen = location.openStatus === 'Open';
            if (isOpen) {
                statusTag.textContent = "OPEN";
                statusTag.style.backgroundColor = '#D1FAE5'; // Light green background
                statusTag.style.color = '#065F46'; // Dark green text
            } else {
                statusTag.textContent = "CLOSED";
                statusTag.style.backgroundColor = '#FEE2E2'; // Light red background
                statusTag.style.color = '#991B1B'; // Dark red text
            }

            // --- 2. Set Availability Text ---
            availableCountEl.textContent = '0'; // Start at 0 for animation
            availableCountEl.classList.add('number-counter');
            availableLabelEl.textContent = `/ ${total} AVAILABLE`;
            
            // Animate the number counter after a short delay
            setTimeout(() => {
                animateNumber(availableCountEl, available, 600);
            }, 100);
            
            // If closed, dim the text
            if (!isOpen) {
                availableCountEl.classList.add('text-gray-400');
                availableLabelEl.classList.add('text-gray-400');
            }

            // --- 3. Set Progress Bar Color & Width with smooth animation ---
            // Set width to 0 initially, then animate to target
            progressBar.style.width = '0%';
            progressBar.style.transition = 'width 0.8s ease-out, background-color 0.3s ease';
            
            // Set color first
            if (!isOpen) {
                progressBar.style.backgroundColor = '#666666'; // Ohio State gray for closed
            } else if (percentUsed < 50) {
                progressBar.style.backgroundColor = '#E8A5A5'; // Light scarlet for not busy
            } else if (percentUsed < 85) {
                progressBar.style.backgroundColor = '#BB0000'; // Ohio State scarlet for busy
            } else {
                progressBar.style.backgroundColor = '#8B0000'; // Dark scarlet for packed
            }
            
            // Animate width after a short delay to allow color to set
            setTimeout(() => {
                progressBar.style.width = `${percentUsed}%`;
            }, 50);

            return card;
        }

        /**
         * Main function to initialize and run the app.
         */
        async function initialize() {
            try {
                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                
                // Sign in anonymously
                await signInAnonymously(auth);
                const userId = auth.currentUser ? auth.currentUser.uid : 'unknown';
                
                if (!auth.currentUser) {
                    throw new Error("Could not authenticate with database.");
                }

                // --- This is the REAL-TIME LISTENER for capacity data ---
                const docRef = doc(db, "live_counts", "JON");
                
                // --- This is the REAL-TIME LISTENER for last scraped timestamp ---
                const lastScrapedRef = doc(db, "app_metadata", "last_scraped");
                
                let previousUpdateTime = null;
                let isFirstLoad = true;
                
                // Listen to last scraped timestamp updates
                onSnapshot(lastScrapedRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        if (data.timestamp) {
                            const serverTime = data.timestamp.toDate();
                            const timeString = serverTime.toLocaleTimeString();
                            
                            // Only pulse if this is a new update (not initial load)
                            if (previousUpdateTime && previousUpdateTime !== timeString) {
                                pulseElement(lastUpdatedEl);
                            }
                            
                            lastUpdatedEl.textContent = `Last Scrape: ${timeString}`;
                            previousUpdateTime = timeString;
                        }
                    } else {
                        // Document doesn't exist yet - scraper hasn't run
                        lastUpdatedEl.textContent = 'Waiting for first scrape...';
                    }
                }, (error) => {
                    console.error("Error listening to last scraped timestamp:", error);
                    lastUpdatedEl.textContent = 'Unable to load timestamp';
                });
                
                // Listen to capacity data updates
                onSnapshot(docRef, (doc) => {
                    // Smoothly fade out loading message
                    if (messageContainer.style.display !== 'none') {
                        messageContainer.classList.add('fade-out');
                        setTimeout(() => {
                            messageContainer.style.display = 'none';
                        }, 300);
                    }
                    
                    grid.innerHTML = ''; // Clear old data

                    if (doc.exists()) {
                        // Fade in grid on first load
                        if (isFirstLoad) {
                            grid.classList.add('fade-in');
                            isFirstLoad = false;
                        }
                        const data = doc.data();
                        const locations = data.locations || [];
                        
                        // Sort locations alphabetically by name
                        locations.sort((a, b) => a.name.localeCompare(b.name));

                        // Render a card for each location with stagger animation
                        locations.forEach((location, index) => {
                            const card = renderCapacityCard(location);
                            grid.appendChild(card);
                            // Add stagger animation
                            animateCardEntry(card, index);
                        });

                    } else {
                        // Document doesn't exist
                        messageText.textContent = "Data not found. Please run the 'scraper.py' script.";
                        messageContainer.style.display = 'block';
                    }
                }, (error) => {
                    // Handle snapshot errors
                    console.error("Snapshot error:", error);
                    messageText.textContent = "Error: Could not connect to the database. Check security rules and network connection.";
                    messageContainer.style.display = 'block';
                });

            } catch (err) {
                console.error("Initialization Error:", err);
                messageText.textContent = `Error: ${err.message}`;
                messageContainer.style.display = 'block';
            }
        }

        // Run the app
        initialize();
    </script>

</body>
</html>

